stages:
    - build
    - test
    - deploy

test:
  image: docker:latest
  services:
    - docker:dind
  stage: test
  before_script: 
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull ${CI_REGISTRY_IMAGE}:$CI_COMMIT_TAG
  script:
    - docker run -p 3000:3000 -d ${CI_REGISTRY_IMAGE}:$CI_COMMIT_TAG
    - "[ $(curl 127.012.34.56:3000/api -w \"%{http_code}\") = \"308\" ]"
    - "[ $(curl 127.012.34.56:3000/api/web_filtering) \"=~\" \"^\\{[\\\"']type[\\\"']:[\\\"'].+[\\\"']}$\" ]"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+.*$/
      when: always

heroku:
    image: ruby:latest
    stage: deploy
    script:
        - gem install dpl
        - dpl --provider=heroku --app=loilo --api-key=$HEROKU_API_KEY
    rules:
        - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+.*$/
          when: manual

docker:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  before_script: 
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - export CONTAINER_ID=$(docker build . -q)
    - docker tag ${CONTAINER_ID} ${CI_REGISTRY_IMAGE}:latest
    - docker push ${CI_REGISTRY_IMAGE}:latest
    - docker tag ${CONTAINER_ID} ${CI_REGISTRY_IMAGE}:$CI_COMMIT_TAG
    - docker push ${CI_REGISTRY_IMAGE}:$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+.*$/
      when: always
